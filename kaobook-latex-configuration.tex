%----------------------------------------------------------------------------------------
%	CUSTOM CODE FROM JULIAN
%----------------------------------------------------------------------------------------

\newskip\tufteskipamount
\tufteskipamount=0.3\baselineskip plus 0.4ex minus 0.2ex % Originally \tufteskipamount=1.0\baselineskip plus 0.5ex minus 0.2ex

\newcommand{\tuftebreak}{\par\ifdim\lastskip<\tufteskipamount
  \removelastskip\penalty-100\tufteskip\fi}

\newcommand{\tufteskip}{\vspace\tufteskipamount}

\makeatletter
\def\tuftebreak{%
  \if@nobreak\else
    \par
    \ifdim\lastskip<\tufteskipamount
      \removelastskip \penalty -100
      \tufteskip
    \fi
  \fi
}
\makeatother

%--------------------------------------------

\newlength\ltempa
\newlength\ltempb
\newcommand\newthought[1]{%
   %\addvspace{1.0\baselineskip plus 0.5ex minus 0.2ex}%
   \noindent\expandafter\formatnewthought#1\relax}
\def\formatnewthought#1#2\relax{%
  \tuftebreak
  \settowidth\ltempa{\textsc{#1#2}}%
  \settowidth\ltempb{\textsc{#1\mbox{}#2}}%
  \addtolength\ltempa{-\ltempb}%
  \textbf{#1}\kern\ltempa\textsc{#2}%
}

%--------------------------------------------
%\usepackage[anythingbreaks]{breakurl}
\usepackage{makeidx}    % from https://tex.stackexchange.com/a/182712/88466
\usepackage{etoolbox}
\appto\UrlBreaks{\do\-\do\/}

\usepackage{mparhack}  % Optionally add [debug] to see details of the fixups in the compilation log.
\usepackage{threeparttable}
\usepackage{comment}
\usepackage{nth}
\usepackage{copyrightbox}
\usepackage{svg}
\usepackage{subfig}
\usepackage[normalem]{ulem}
\usepackage{cancel}  % https://jansoehlke.com/2010/06/strikethrough-in-latex/
\useunder{\uline}{\ul}{}

\setminted{fontsize=\small,baselinestretch=1}  % shrink code samples so they don't overwhelm the text.
%--------------------------------------------

\newcommand{\secref}[1]{\autoref{#1}. \nameref{#1}} % \secref{section:my} %from https://stackoverflow.com/a/30844515/340175

%--------------------------------------------

% comment these for final
\newcommand{\yijun}[1]{\textcolor{red}{[YY: #1 ?]}}
% \def\yy#1#2{\textcolor{red}{#1}\footnote{YY:{#2}\textcolor{black}}}
\newcommand{\yy}[2]{{#1}\footnote{YY:{#2}}}

\newcommand{\akb}[1]{\textcolor{purple}{[AKB: #1]}}
\newcommand{\arosha}[1]{\textcolor{purple}{[AKB: #1 ?]}}

\newcommand{\marian}[1]{\textcolor{blue}{[MP: #1 ?]}}
\newcommand{\julian}[1]{\textcolor{olive}{[JH: #1]}}
\newcommand{\isabel}[1]{\textcolor{brown}{[IE: #1]}}


%--------------------------------------------

% To address the error: Class scrbook Error: undefined old font command `\sf'.
% From: https://github.com/ftilmann/latexdiff/issues/92 
\makeatletter
\DeclareOldFontCommand{\rm}{\normalfont\rmfamily}{\mathrm}
\DeclareOldFontCommand{\sf}{\normalfont\sffamily}{\mathsf}
\DeclareOldFontCommand{\tt}{\normalfont\ttfamily}{\mathtt}
\DeclareOldFontCommand{\bf}{\normalfont\bfseries}{\mathbf}
\DeclareOldFontCommand{\it}{\normalfont\itshape}{\mathit}
\DeclareOldFontCommand{\sl}{\normalfont\slshape}{\@nomath\sl}
\DeclareOldFontCommand{\sc}{\normalfont\scshape}{\@nomath\sc}
\makeatother

%----------------------------------------------------------------------------------------
% From https://tex.stackexchange.com/a/330980/88466
% It fixes several compilation warnings about having \\ to split the title of the thesis, etc.

\pdfstringdefDisableCommands{%
  \def\\{}%
  \def\texttt#1{<#1>}%
}

%----------------------------------------------------------------------------------------
% The following clashes with the \requirepackage{todonotes} which is part of kaobook
%\usepackage[colorinlistoftodos,prependcaption,textsize=tiny]{todonotes}  % From https://tex.stackexchange.com/a/178806/88466

\begin{comment}
\newcommandx{\unsure}[2][1=]{\todo[linecolor=red,backgroundcolor=red!25,bordercolor=red,#1]{#2}}
\newcommandx{\change}[2][1=]{\todo[linecolor=blue,backgroundcolor=blue!25,bordercolor=blue,#1]{#2}}
\newcommandx{\pending}[2][1=]{\todo[linecolor=OliveGreen,backgroundcolor=OliveGreen!25,bordercolor=OliveGreen,#1]{#2}}
\newcommandx{\improvement}[2][1=]{\todo[linecolor=Plum,backgroundcolor=Plum!25,bordercolor=Plum,#1]{#2}}
\newcommandx{\thiswillnotshow}[2][1=]{\todo[disable,#1]{#2}}
\end{comment}

%----------------------------------------------------------------------------------------
% Adjustbox is used to shrink a couple of large tables. I'd like to find a better approach, however it does an adequate job.

\usepackage{adjustbox}

%----------------------------------------------------------------------------------------
% Limit the per chapter mini table of contents to showing sections, not subsections.
\setcounter{margintocdepth}{\sectiontocdepth}

%----------------------------------------------------------------------------------------
\usepackage{array,tabularx,longtable,tabu}
\usepackage{booktabs}
\newcolumntype{R}[1]{>{\raggedleft\arraybackslash}p{#1}} % Define a new right-aligned paragraph column type
\newcolumntype{L}[1]{>{\raggedright\arraybackslash}p{#1}} % Define a new left-aligned (no justification) paragraph column type
\newcolumntype{C}[1]{>{\centering\arraybackslash}p{#1}} % Define a new centered paragraph column type


%----------------------------------------------------------------------------------------
\usepackage{epigraph} % To have quotes at the start of chapters.
\setlength{\epigraphwidth}{0.5\linewidth}
%----------------------------------------------------------------------------------------

%%%%%%% A set of macros for the six perspectives
% Implementation inspired by https://newbedev.com/how-to-change-dot-spacing-in-dotfill

\makeatletter
\newcommand \iuse {I\textsuperscript{use}}
\newcommand \iartefacts {I\textsuperscript{artefacts}}
\newcommand \itools {I\textsuperscript{tools}}
\newcommand \uuse {U\textsuperscript{use}}
\newcommand \uartefacts {U\textsuperscript{artefacts}}
\newcommand \utools {U\textsuperscript{tools}}
\makeatother 

%----------------------------------------------------------------------------------------
% This quick and dirty approach comes from a comment on https://tex.stackexchange.com/q/191295/88466
% A quick and dirty method is to wrap the text into a command, which both prints your text and the makes an entry to the index: \newcommand{\myindex}[1]{#1\index{#1}}, e.g. \myindex{Einstein} will print Einstein right there and generates the index entry Einstein too. However, this is a cheap 'hack' and will not work for more sophisticated index entries ;-) â€“ user31729  Jul 13, 2014 at 15:15 

% I'll try using it for now, otherwise I can advance to the improved approach in the answer https://tex.stackexchange.com/a/191303/88466

\newcommand{\myindex}[1]{#1\index{#1}}

% https://tex.stackexchange.com/a/182712/88466
\patchcmd{\theindex}{\thispagestyle{plain}}
  {\thispagestyle{plain}\phantomsection\label{index}}{}{}

%----------------------------------------------------------------------------------------
% Source: https://tex.stackexchange.com/a/604560/88466
% It's to enable coloured kaoboxes

\definecolor{greentitle}{RGB}{61,170,61}
\definecolor{greentitleback}{RGB}{216,233,213}
\definecolor{drakgreentitle}{RGB}{24,131,80}

\DeclareTColorBox{experience}{O{}o}{
    enhanced,
    breakable,
    arc=0pt,
    boxrule=0pt,
    colback=white,
    top=3em, % you can change the top spacing
    overlay unbroken and first={
        % draw box on the left
        \node[fill=greentitleback,
            font=\color{greentitle}\sffamily\bfseries\large,
            anchor=south west,
            xshift=2mm,
            yshift=-2em, % you can change xshift and yshift to adjust the title placement
        ] (titlebox) at (frame.north west) 
        % notice the difference here, kaocounter is used instead
        {Exercise \refstepcounter{kaocounter}\thekaocounter
        % add cross-referencing support
        \IfValueT{#2}{\label{#2}}
        };
        
        % write title on the right
        \node[font=\color{drakgreentitle}\sffamily\large, 
        anchor=west
        ] at ($(titlebox.east)+(2mm,0mm)$) {#1};
        
        % draw the vertical line on the left
        \draw[draw=greentitleback, line width=2pt] 
            (titlebox.north west-|frame.north west)--(frame.south west);
    },
    overlay middle and last={
        \draw[draw=greentitleback, line width=2pt] 
            (frame.north west)--(frame.south west);
    }
    fonttitle=\color{greentitle}\sffamily\bfseries,
}

\DeclareTColorBox{genericbox}{m}{
    enhanced,
    breakable,
    arc=0pt,
    boxrule=0pt,
    colback=yellow,
    attach boxed title to top left,
    boxed title style={
        colback=white,
        colframe=white,
    },
    title={#1},
    fonttitle=\color{greentitle}\sffamily\bfseries\large
}
%----------------------------------------------------------------------------------------